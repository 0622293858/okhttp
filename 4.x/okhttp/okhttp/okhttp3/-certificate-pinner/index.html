<HTML>
<HEAD>
<meta charset="UTF-8">
<title>CertificatePinner - okhttp</title>
<link rel="stylesheet" href="../../../style.css">
</HEAD>
<BODY>
<a href="../../index.html">okhttp</a>&nbsp;/&nbsp;<a href="../index.html">okhttp3</a>&nbsp;/&nbsp;<a href="./index.html">CertificatePinner</a><br/>
<br/>
<h1>CertificatePinner</h1>
<code><span class="keyword">data</span> <span class="keyword">class </span><span class="identifier">CertificatePinner</span></code>
<p>Constrains which certificates are trusted. Pinning certificates defends against attacks on
certificate authorities. It also prevents connections through man-in-the-middle certificate
authorities either known or unknown to the application's user.
This class currently pins a certificate's Subject Public Key Info as described on
<a href="http://goo.gl/AIx3e5">Adam Langley's Weblog</a>. Pins are either base64 SHA-256 hashes as in
<a href="http://tools.ietf.org/html/rfc7469">HTTP Public Key Pinning (HPKP)</a> or SHA-1 base64 hashes as in Chromium's
<a href="http://goo.gl/XDh6je">static certificates</a>.</p>
<h2>Setting up Certificate Pinning</h2>
<p>The easiest way to pin a host is turn on pinning with a broken configuration and read the
expected configuration when the connection fails. Be sure to do this on a trusted network, and
without man-in-the-middle tools like <a href="http://charlesproxy.com">Charles</a> or <a href="http://fiddlertool.com">Fiddler</a>.</p>
<p>For example, to pin <code>https://publicobject.com</code>, start with a broken configuration:</p>
<pre><code>String hostname = "publicobject.com";
CertificatePinner certificatePinner = new CertificatePinner.Builder()
    .add(hostname, "sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=")
    .build();
OkHttpClient client = OkHttpClient.Builder()
    .certificatePinner(certificatePinner)
    .build();

Request request = new Request.Builder()
    .url("https://" + hostname)
    .build();
client.newCall(request).execute();
</code></pre>
<p>As expected, this fails with a certificate pinning exception:</p>
<pre><code>javax.net.ssl.SSLPeerUnverifiedException: Certificate pinning failure!
Peer certificate chain:
    sha256/afwiKY3RxoMmLkuRW1l7QsPZTJPwDS2pdDROQjXw8ig=: CN=publicobject.com, OU=PositiveSSL
    sha256/klO23nT2ehFDXCfx3eHTDRESMz3asj1muO+4aIdjiuY=: CN=COMODO RSA Secure Server CA
    sha256/grX4Ta9HpZx6tSHkmCrvpApTQGo67CYDnvprLg5yRME=: CN=COMODO RSA Certification Authority
    sha256/lCppFqbkrlJ3EcVFAkeip0+44VaoJUymbnOaEUk7tEU=: CN=AddTrust External CA Root
Pinned certificates for publicobject.com:
    sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
  at okhttp3.CertificatePinner.check(CertificatePinner.java)
  at okhttp3.Connection.upgradeToTls(Connection.java)
  at okhttp3.Connection.connect(Connection.java)
  at okhttp3.Connection.connectAndSetOwner(Connection.java)
</code></pre>
<p>Follow up by pasting the public key hashes from the exception into the
certificate pinner's configuration:</p>
<pre><code>CertificatePinner certificatePinner = new CertificatePinner.Builder()
    .add("publicobject.com", "sha256/afwiKY3RxoMmLkuRW1l7QsPZTJPwDS2pdDROQjXw8ig=")
    .add("publicobject.com", "sha256/klO23nT2ehFDXCfx3eHTDRESMz3asj1muO+4aIdjiuY=")
    .add("publicobject.com", "sha256/grX4Ta9HpZx6tSHkmCrvpApTQGo67CYDnvprLg5yRME=")
    .add("publicobject.com", "sha256/lCppFqbkrlJ3EcVFAkeip0+44VaoJUymbnOaEUk7tEU=")
    .build();
</code></pre>
<p>Pinning is per-hostname and/or per-wildcard pattern. To pin both <code>publicobject.com</code> and
<code>www.publicobject.com</code>, you must configure both hostnames.</p>
<p>Wildcard pattern rules:</p>
<ol><li>Asterisk <code>*</code> is only permitted in the left-most domain name label and must be the only
    character in that label (i.e., must match the whole left-most label). For example,
    <code>*.example.com</code> is permitted, while <code>*a.example.com</code>, <code>a*.example.com</code>, <code>a*b.example.com</code>,
    <code>a.*.example.com</code> are not permitted.</li>
<li>Asterisk <code>*</code> cannot match across domain name labels. For example, <code>*.example.com</code> matches
    <code>test.example.com</code> but does not match <code>sub.test.example.com</code>.</li>
<li>Wildcard patterns for single-label domain names are not permitted.</li>
</ol>
<p>If hostname pinned directly and via wildcard pattern, both direct and wildcard pins will be used.
For example: <code>*.example.com</code> pinned with <code>pin1</code> and <code>a.example.com</code> pinned with <code>pin2</code>, to check
<code>a.example.com</code> both <code>pin1</code> and <code>pin2</code> will be used.</p>
<h2>Warning: Certificate Pinning is Dangerous!</h2>
<p>Pinning certificates limits your server team's abilities to update their TLS certificates. By
pinning certificates, you take on additional operational complexity and limit your ability to
migrate between certificate authorities. Do not use certificate pinning without the blessing of
your server's TLS administrator!</p>
<h3>Note about self-signed certificates</h3>
<p><a href="./index.html">CertificatePinner</a> can not be used to pin self-signed certificate if such certificate is not
accepted by <a href="https://docs.oracle.com/javase/8/docs/api/javax/net/ssl/TrustManager.html">javax.net.ssl.TrustManager</a>.</p>
<p>See also <a href="https://www.owasp.org/index.php/Certificate_and_Public_Key_Pinning">OWASP: Certificate and Public Key Pinning</a>.</p>
<h3>Types</h3>
<table>
<tbody>
<tr>
<td>
<p><a href="-builder/index.html">Builder</a></p>
</td>
<td>
<code><span class="keyword">class </span><span class="identifier">Builder</span></code>
<p>Builds a configured certificate pinner.</p>
</td>
</tr>
</tbody>
</table>
<h3>Functions</h3>
<table>
<tbody>
<tr>
<td>
<p><a href="check.html">check</a></p>
</td>
<td>
<code><span class="keyword">fun </span><span class="identifier">check</span><span class="symbol">(</span><span class="identifier" id="okhttp3.CertificatePinner$check(kotlin.String, kotlin.collections.List((java.security.cert.Certificate)))/hostname">hostname</span><span class="symbol">:</span>&nbsp;<a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-string/index.html"><span class="identifier">String</span></a><span class="symbol">, </span><span class="identifier" id="okhttp3.CertificatePinner$check(kotlin.String, kotlin.collections.List((java.security.cert.Certificate)))/peerCertificates">peerCertificates</span><span class="symbol">:</span>&nbsp;<a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/-list/index.html"><span class="identifier">List</span></a><span class="symbol">&lt;</span><a href="https://docs.oracle.com/javase/8/docs/api/java/security/cert/Certificate.html"><span class="identifier">Certificate</span></a><span class="symbol">&gt;</span><span class="symbol">)</span><span class="symbol">: </span><a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-unit/index.html"><span class="identifier">Unit</span></a></code>
<p>Confirms that at least one of the certificates pinned for <code>hostname</code> is in <code>peerCertificates</code>.
Does nothing if there are no certificates pinned for <code>hostname</code>. OkHttp calls this after a
successful TLS handshake, but before the connection is used.</p>
</td>
</tr>
</tbody>
</table>
<h3>Companion Object Properties</h3>
<table>
<tbody>
<tr>
<td>
<p><a href="-d-e-f-a-u-l-t.html">DEFAULT</a></p>
</td>
<td>
<code><span class="keyword">val </span><span class="identifier">DEFAULT</span><span class="symbol">: </span><a href="./index.html"><span class="identifier">CertificatePinner</span></a></code></td>
</tr>
</tbody>
</table>
<h3>Companion Object Functions</h3>
<table>
<tbody>
<tr>
<td>
<p><a href="pin.html">pin</a></p>
</td>
<td>
<code><span class="keyword">fun </span><span class="identifier">pin</span><span class="symbol">(</span><span class="identifier" id="okhttp3.CertificatePinner.Companion$pin(java.security.cert.Certificate)/certificate">certificate</span><span class="symbol">:</span>&nbsp;<a href="https://docs.oracle.com/javase/8/docs/api/java/security/cert/Certificate.html"><span class="identifier">Certificate</span></a><span class="symbol">)</span><span class="symbol">: </span><a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-string/index.html"><span class="identifier">String</span></a></code>
<p>Returns the SHA-256 of <code>certificate</code>'s public key.</p>
</td>
</tr>
</tbody>
</table>
</BODY>
</HTML>
